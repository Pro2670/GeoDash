<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo-Dash Fixed Physics</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Teko:wght@500;700&display=swap');
    body { margin: 0; background: #000; overflow: hidden; font-family: 'Teko', sans-serif; }
    canvas { display: block; width: 100vw; height: 100vh; }
    #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; }
    .menu { pointer-events: auto; background: rgba(0,0,0,0.9); border: 4px solid #0ff; padding: 30px; text-align: center; color: white; border-radius: 15px; }
    .hidden { display: none; }
    button { background: #0ff; border: none; padding: 10px 20px; font-family: 'Teko'; font-size: 24px; cursor: pointer; margin: 10px; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="ui">
    <div id="main-menu" class="menu">
        <h1>GEO-DASH</h1>
        <button onclick="startLevel(0)">PLAY LEVEL 1</button>
        <button onclick="startLevel(1)">PLAY LEVEL 2</button>
    </div>
    <div id="death-screen" class="menu hidden">
        <h1 style="color:red">CRASHED</h1>
        <button onclick="restart()">RETRY</button>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 60;

let gameState = "MENU";
let player = { x: 0, y: 0, w: 40, h: 40, dx: 9, dy: 0, angle: 0, grounded: false };
let cameraX = 0;
let map = [];

// --- PHYSICS ENGINE (THE FIX) ---
function update() {
    if (gameState !== "PLAYING") return;

    player.x += player.dx;
    player.dy += 1.6; // Gravity
    player.y += player.dy;
    cameraX = player.x - 200;

    let onSomething = false;

    for (let obj of map) {
        // Only check blocks near the player
        if (obj.x < player.x - 100 || obj.x > player.x + 100) continue;

        // Check if player is falling into the top of a block
        if (player.x + player.w > obj.x && 
            player.x < obj.x + TILE && 
            player.y + player.h > obj.y && 
            player.y + player.h < obj.y + 30 && // Only catch the top 30 pixels
            player.dy >= 0) { 
            
            player.y = obj.y - player.h;
            player.dy = 0;
            onSomething = true;
        } 
        // If not landing on top, check if hitting the FRONT of the block
        else if (player.x + player.w > obj.x + 5 && 
                 player.x < obj.x + TILE - 5 && 
                 player.y + player.h > obj.y + 5 && 
                 player.y < obj.y + TILE - 5) {
            
            if (obj.type === "spike") die();
            else if (obj.type === "block") die();
        }
    }

    player.grounded = onSomething;
    if (player.grounded) {
        player.angle = Math.round(player.angle / 90) * 90;
    } else {
        player.angle += 7;
    }

    if (player.y > canvas.height) die();
}

function die() {
    gameState = "DEAD";
    document.getElementById('death-screen').classList.remove('hidden');
}

// --- LEVEL SETUP ---
function startLevel(id) {
    const levels = [
        "..........11111111112..11111...2...1111111111",
        "..........11112221111...1111...1111...1111"
    ];
    
    map = [];
    // Build a solid floor for the start
    for(let i=0; i<15; i++) map.push({x: i*TILE, y: canvas.height - TILE, type: "block"});
    
    // Build the level
    levels[id].split('').forEach((char, i) => {
        let x = (i + 15) * TILE;
        let y = canvas.height - TILE;
        map.push({x: x, y: y, type: "block"}); // Floor
        if(char === "1") map.push({x: x, y: y - TILE, type: "block"});
        if(char === "2") map.push({x: x, y: y - TILE, type: "spike"});
    });

    player.x = 100;
    player.y = canvas.height - 400; // Start HIGH in the air
    player.dy = 0;
    gameState = "PLAYING";
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('death-screen').classList.add('hidden');
}

function restart() { startLevel(0); }

// --- DRAWING ---
function draw() {
    ctx.fillStyle = "#001";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-cameraX, 0);

    for (let obj of map) {
        if (obj.type === "block") {
            ctx.fillStyle = "#000";
            ctx.strokeStyle = "#0ff";
            ctx.lineWidth = 2;
            ctx.fillRect(obj.x, obj.y, TILE, TILE);
            ctx.strokeRect(obj.x, obj.y, TILE, TILE);
        } else {
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.moveTo(obj.x, obj.y + TILE);
            ctx.lineTo(obj.x + TILE/2, obj.y);
            ctx.lineTo(obj.x + TILE, obj.y + TILE);
            ctx.fill();
        }
    }

    ctx.save();
    ctx.translate(player.x + 20, player.y + 20);
    ctx.rotate(player.angle * Math.PI / 180);
    ctx.fillStyle = "#f0f";
    ctx.fillRect(-20, -20, 40, 40);
    ctx.strokeStyle = "#fff";
    ctx.strokeRect(-20, -20, 40, 40);
    ctx.restore();

    ctx.restore();
    requestAnimationFrame(() => { update(); draw(); });
}

window.addEventListener('keydown', (e) => { 
    if (e.code === "Space" && player.grounded) player.dy = -22; 
});
window.addEventListener('mousedown', () => { 
    if (player.grounded) player.dy = -22; 
});

draw();
</script>
</body>
</html>
