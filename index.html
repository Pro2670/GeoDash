<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo-Dash Ultimate</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Teko:wght@500;700&display=swap');
    body { margin: 0; background: #111; overflow: hidden; font-family: 'Teko', sans-serif; user-select: none; }
    canvas { display: block; width: 100vw; height: 100vh; }
    
    /* UI STYLES */
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .panel { pointer-events: auto; background: rgba(0,0,0,0.9); border: 2px solid #0ff; padding: 20px; text-align: center; border-radius: 10px; max-width: 600px; width: 90%; box-shadow: 0 0 20px #0ff; max-height: 80vh; overflow-y: auto; }
    .hidden { display: none !important; }
    
    h1 { color: #fff; font-size: 50px; margin: 0; text-shadow: 3px 3px #000; -webkit-text-stroke: 1px #0ff; }
    h2 { color: #0ff; margin: 10px 0; }
    
    button {
        background: linear-gradient(to bottom, #00f0ff, #0099ff);
        border: 2px solid #fff; color: #000; font-family: 'Teko', sans-serif;
        font-size: 22px; padding: 10px 20px; margin: 5px; cursor: pointer;
        font-weight: bold; transform: skew(-10deg); transition: 0.2s;
    }
    button:hover { transform: skew(-10deg) scale(1.1); filter: brightness(1.2); }
    button.red { background: linear-gradient(to bottom, #ff5555, #aa0000); }
    button.green { background: linear-gradient(to bottom, #55ff55, #00aa00); }

    .grid-row { display: flex; justify-content: center; }
    .level-btn { width: 100%; text-align: left; }
    
    /* EDITOR STYLES */
    #editor-ui { position: absolute; bottom: 0; left: 0; width: 100%; background: #222; padding: 10px; display: flex; gap: 10px; pointer-events: auto; border-top: 2px solid #0ff; }
    .tile-selector { width: 40px; height: 40px; border: 2px solid #555; cursor: pointer; display: flex; justify-content: center; align-items: center; color: white; }
    .tile-selector.active { border-color: #0ff; background: #333; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer">
    <div id="main-menu" class="panel">
        <h1>GEO-DASH ULTIMATE</h1>
        <div style="margin: 20px;">
            <div id="icon-preview" style="width:50px; height:50px; margin:0 auto; background:#0ff; border:2px solid white;"></div>
            <button onclick="changeColor()">Change Color</button>
        </div>
        <hr style="border-color: #333;">
        <h2>CAMPAIGN LEVELS</h2>
        <div id="campaign-list"></div>
        <hr style="border-color: #333;">
        <h2>CUSTOM LEVELS</h2>
        <button class="green" onclick="openEditor()">CREATE NEW LEVEL</button>
        <div id="custom-list"></div>
    </div>

    <div id="game-over" class="panel hidden">
        <h1 style="color:red; -webkit-text-stroke:1px red;">CRASHED!</h1>
        <h2 id="percent-display">0%</h2>
        <button onclick="restartLevel()">Try Again</button>
        <button class="red" onclick="showMenu()">Exit</button>
    </div>

    <div id="editor-overlay" class="panel hidden" style="background:none; border:none; box-shadow:none; pointer-events:none; top: 10px; position: absolute;">
        <h1 style="font-size: 30px;">EDITOR MODE</h1>
    </div>
</div>

<div id="editor-ui" class="hidden">
    <div class="tile-selector active" onclick="setEditTool(1)">BLK</div>
    <div class="tile-selector" onclick="setEditTool(2)">SPK</div>
    <div class="tile-selector" onclick="setEditTool(3)">SHIP</div>
    <div class="tile-selector" onclick="setEditTool(4)">CUBE</div>
    <div class="tile-selector" onclick="setEditTool(0)">ERA</div>
    <button onclick="saveCustomLevel()" style="margin-left:auto; font-size: 16px;">SAVE</button>
    <button class="red" onclick="showMenu()" style="font-size: 16px;">EXIT</button>
</div>

<script>
/** * GEO-DASH ENGINE CONFIGURATION 
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 50;
let SCREEN_W, SCREEN_H;

// --- STATE MANAGEMENT ---
let gameState = "MENU"; // MENU, PLAYING, EDITOR, DEAD
let currentLevelData = "";
let isCustom = false;
let frame = 0;
let cameraX = 0;
let scorePercent = 0;

// --- AUDIO SYNTH ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq, type, duration) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
}

// --- PLAYER OBJECT ---
const player = {
    x: 0, y: 0, w: 40, h: 40,
    dx: 8, dy: 0,
    angle: 0,
    mode: 'cube', // 'cube' or 'ship'
    grounded: false,
    color: '#00f0ff',
    trail: []
};

// --- 10 PRE-MADE LEVELS (Safe starts included) ---
// Key: . = Air, 1 = Block, 2 = Spike, 3 = Ship Portal, 4 = Cube Portal
const campaignLevels = [
    {name: "1. Stereo Start", data: "..........1............................................................11...2..11......................."},
    {name: "2. The Humps", data: "..........1...........111.......111.......111..................2.......11...2..11.......2.......111..."},
    {name: "3. Flight School", data: "..........3...................1.....................1......1..............1..............111111111....4..."},
    {name: "4. Danger Zone", data: "..........1.......2.2.2.......111.......2.......111...2...111.......3.........1111...................."},
    {name: "5. High Flyer", data: "..........3.......................111..................111..................222......................."},
    {name: "6. Precision", data: "..........1...2...1...2...1...111111...2...2...1111.......11.......2.2.2.11111........................"},
    {name: "7. The Cave", data: "..........111111111111111111...11111...11111...11111...11111.........................................."},
    {name: "8. Switch Up", data: "..........1.......3..............1111..............4.......111.......3..............1111.............."},
    {name: "9. Spike Field", data: "..........1...2...2...2...111...2...2...2...111...222...111...222...11111111.........................."},
    {name: "10. Final Exam", data: "..........1...2...3..............1111.......2.......4.......111...2...3..............111111...2...2..."}
];

// --- INITIALIZATION ---
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    SCREEN_W = canvas.width;
    SCREEN_H = canvas.height;
}
window.addEventListener('resize', resize);
resize();

// --- MENU LOGIC ---
function renderMenu() {
    const list = document.getElementById('campaign-list');
    list.innerHTML = "";
    campaignLevels.forEach((lvl, i) => {
        list.innerHTML += `<button class="level-btn" onclick="loadLevel(${i})">${lvl.name}</button>`;
    });

    // Load Custom Levels
    const customList = document.getElementById('custom-list');
    customList.innerHTML = "";
    let saved = JSON.parse(localStorage.getItem('geoDashLevels') || "[]");
    saved.forEach((lvl, i) => {
        customList.innerHTML += `<div style="display:flex;">
            <button class="level-btn" onclick="playCustom(${i})">${lvl.name}</button>
            <button class="red" onclick="deleteCustom(${i})" style="width:50px">X</button>
        </div>`;
    });
}

let colorIdx = 0;
const colors = ['#00f0ff', '#ff0055', '#55ff55', '#ffff00', '#aa00ff'];
function changeColor() {
    colorIdx = (colorIdx + 1) % colors.length;
    player.color = colors[colorIdx];
    document.getElementById('icon-preview').style.backgroundColor = player.color;
}

// --- LEVEL PARSING ---
let mapObjects = [];
let levelEndX = 0;

function parseMap(dataString) {
    mapObjects = [];
    // Floor
    for(let i=0; i<dataString.length + 20; i++) {
        mapObjects.push({x: i*TILE_SIZE, y: SCREEN_H - TILE_SIZE, type: 1, w: TILE_SIZE, h: TILE_SIZE});
    }
    
    // Level Data
    // We parse the string. To make it simple for the editor, the string represents blocks just above the floor.
    // In a full game, we'd use a 2D array. Here we use a 1D string for the "obstacle layer".
    let chars = dataString.split('');
    chars.forEach((c, i) => {
        let x = i * TILE_SIZE;
        let y = SCREEN_H - (TILE_SIZE * 2); // Layer above floor
        
        if(c === '1') { // Block
            mapObjects.push({x:x, y:y, type:1, w:TILE_SIZE, h:TILE_SIZE});
        } else if (c === '2') { // Spike
            mapObjects.push({x:x, y:y + 20, type:2, w:TILE_SIZE, h:30}); // Short spike
        } else if (c === '3') { // Ship Portal
            mapObjects.push({x:x, y:y, type:3, w:TILE_SIZE/2, h:TILE_SIZE*2});
        } else if (c === '4') { // Cube Portal
            mapObjects.push({x:x, y:y, type:4, w:TILE_SIZE/2, h:TILE_SIZE*2});
        }
    });
    levelEndX = chars.length * TILE_SIZE;
}

// --- GAME LOOP & PHYSICS ---
function loadLevel(idx) {
    startSession(campaignLevels[idx].data);
}
function playCustom(idx) {
    let saved = JSON.parse(localStorage.getItem('geoDashLevels'));
    startSession(saved[idx].data);
}
function startSession(data) {
    currentLevelData = data;
    parseMap(data);
    resetPlayer();
    gameState = "PLAYING";
    document.getElementById('ui-layer').childNodes.forEach(n=>n.nodeType===1 && n.classList.add('hidden'));
    document.getElementById('ui-layer').style.pointerEvents = "none";
    loop();
}

function resetPlayer() {
    player.x = 0;
    player.y = SCREEN_H - (TILE_SIZE * 3); // Spawn in air
    player.dy = 0;
    player.mode = 'cube';
    player.angle = 0;
    cameraX = 0;
    frame = 0;
}

function update() {
    if(gameState !== "PLAYING") return;

    // Movement
    player.x += player.dx;
    cameraX = player.x - 200;

    // Physics based on Mode
    if(player.mode === 'cube') {
        player.dy += 1.5; // Gravity
        if(player.grounded) {
            let snap = Math.round(player.angle/90)*90;
            player.angle += (snap - player.angle)*0.2;
        } else {
            player.angle += 6;
        }
    } else {
        // Ship Mode
        player.dy += 0.6; // Lighter Gravity
        if(mouseDown) player.dy -= 1.2; // Thrust
        player.angle = player.dy * 2; // Tilt based on velocity
    }
    
    player.y += player.dy;
    
    // Collisions
    player.grounded = false;
    let crash = false;
    
    // Check every object
    // Optimization: Only check objects near player
    let pRect = {l: player.x+10, r: player.x+player.w-10, t: player.y+10, b: player.y+player.h-10};
    
    if(player.y > SCREEN_H + 100) crash = true; // Fell out of world

    for(let obj of mapObjects) {
        if(obj.x < player.x - 100 || obj.x > player.x + 200) continue;
        
        // AABB
        if (pRect.r > obj.x && pRect.l < obj.x + obj.w && pRect.b > obj.y && pRect.t < obj.y + obj.h) {
            
            if(obj.type === 2) { // Spike
                crash = true;
            } else if (obj.type === 3) { // Ship Portal
                player.mode = 'ship';
            } else if (obj.type === 4) { // Cube Portal
                player.mode = 'cube';
                player.angle = 0; // Reset rotation
            } else if (obj.type === 1) { // Block/Floor
                // Resolve Collision
                let overlapX = (pRect.r - obj.x) < (obj.x + obj.w - pRect.l) ? -(pRect.r - obj.x) : (obj.x + obj.w - pRect.l);
                let overlapY = (pRect.b - obj.y) < (obj.y + obj.h - pRect.t) ? -(pRect.b - obj.y) : (obj.y + obj.h - pRect.t);

                if (Math.abs(overlapX) < Math.abs(overlapY)) {
                    // X Collision (Side hit)
                    crash = true; 
                } else {
                    // Y Collision
                    if(overlapY < 0) { // Landed on top
                        player.y += overlapY - 10; // -10 accounts for hitbox padding
                        player.dy = 0;
                        player.grounded = true;
                    } else { // Hit head
                        player.y += overlapY + 10;
                        player.dy = 0;
                        if(player.mode === 'cube') crash = true; // Cube dies on head hit usually
                    }
                }
            }
        }
    }

    if(crash) playerDie();
    
    // Win Condition
    scorePercent = Math.min(100, Math.floor((player.x / levelEndX) * 100));
    if(player.x > levelEndX + 500) {
        gameState = "MENU";
        alert("Level Complete!");
        showMenu();
    }
}

function playerDie() {
    gameState = "DEAD";
    playTone(150, 'sawtooth', 0.5);
    document.getElementById('percent-display').innerText = scorePercent + "%";
    document.getElementById('game-over').classList.remove('hidden');
}

function jump() {
    if(gameState === "PLAYING" && player.mode === 'cube' && player.grounded) {
        player.dy = -22;
        player.grounded = false;
        playTone(400, 'square', 0.1);
    }
}

// --- RENDERING ---
function draw() {
    // BG
    ctx.fillStyle = player.mode === 'ship' ? "#1a051a" : "#051a2e";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid (Parallax)
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 2;
    let offX = -(cameraX * 0.5) % 100;
    for(let i=offX; i<canvas.width; i+=100) {
        ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke();
    }

    ctx.save();
    ctx.translate(-cameraX, 0);

    // Draw Map
    for(let obj of mapObjects) {
        if(obj.x < cameraX - 100 || obj.x > cameraX + canvas.width + 100) continue;
        
        if(obj.type === 1) { // Block
            ctx.fillStyle = "#000";
            ctx.strokeStyle = "#0ff";
            ctx.lineWidth = 3;
            ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            // Inner glow
            ctx.fillStyle = "rgba(0,255,255,0.2)";
            ctx.fillRect(obj.x+5, obj.y+5, obj.w-10, obj.h-10);
        } else if(obj.type === 2) { // Spike
            ctx.fillStyle = "#f00";
            ctx.beginPath();
            ctx.moveTo(obj.x, obj.y + 30);
            ctx.lineTo(obj.x + 25, obj.y);
            ctx.lineTo(obj.x + 50, obj.y + 30);
            ctx.fill();
            ctx.strokeStyle = "#fff"; ctx.stroke();
        } else if(obj.type === 3) { // Ship Portal
            ctx.fillStyle = "pink";
            ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        } else if(obj.type === 4) { // Cube Portal
            ctx.fillStyle = "lime";
            ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        }
    }

    // Draw Player
    if(gameState === "PLAYING") {
        ctx.translate(player.x + player.w/2, player.y + player.h/2);
        ctx.rotate(player.angle * Math.PI / 180);
        
        ctx.fillStyle = player.color;
        
        if(player.mode === 'cube') {
            // CUBE ICON
            ctx.fillRect(-20, -20, 40, 40);
            ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.strokeRect(-20,-20,40,40);
            // Face
            ctx.fillStyle = "black";
            ctx.fillRect(-5, -5, 15, 15); // Eye
            ctx.fillRect(10, -5, 5, 5); // Small eye
        } else {
            // SHIP ICON (Rocket)
            ctx.beginPath();
            ctx.moveTo(20, 0); // Nose
            ctx.lineTo(-15, 15); // Bottom Left
            ctx.lineTo(-15, -15); // Top Left
            ctx.fill();
            ctx.strokeStyle = "white"; ctx.stroke();
            // Cockpit
            ctx.fillStyle="black"; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }
    
    ctx.restore();
    
    // Editor Grid
    if(gameState === "EDITOR") drawEditor();
}

// --- EDITOR LOGIC ---
let editTool = 1;
let editorData = []; // Array of chars

function openEditor() {
    gameState = "EDITOR";
    document.getElementById('ui-layer').childNodes.forEach(n=>n.nodeType===1 && n.classList.add('hidden'));
    document.getElementById('editor-ui').classList.remove('hidden');
    document.getElementById('editor-overlay').classList.remove('hidden');
    
    // Initialize 100 empty slots
    editorData = new Array(200).fill('.');
    // Set first 5 to empty always for safety
    cameraX = -100;
    loop();
}

function setEditTool(t) {
    editTool = t;
    document.querySelectorAll('.tile-selector').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tile-selector')[t===0?4:t-1].classList.add('active');
}

function drawEditor() {
    ctx.save();
    ctx.translate(-cameraX, 0);
    
    // Draw grid lines
    ctx.strokeStyle = "#333";
    for(let i=0; i<editorData.length; i++) {
        let x = i * TILE_SIZE;
        let y = SCREEN_H - (TILE_SIZE * 2);
        
        ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE); // Block layer
        ctx.strokeRect(x, y + TILE_SIZE, TILE_SIZE, TILE_SIZE); // Floor layer
        
        // Draw placed objects
        let c = editorData[i];
        if(c === '1') { ctx.fillStyle="#0ff"; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE); }
        if(c === '2') { ctx.fillStyle="#f00"; ctx.beginPath(); ctx.moveTo(x,y+50); ctx.lineTo(x+25,y+20); ctx.lineTo(x+50,y+50); ctx.fill(); }
        if(c === '3') { ctx.fillStyle="pink"; ctx.fillText("SHIP", x, y+30); }
        if(c === '4') { ctx.fillStyle="lime"; ctx.fillText("CUBE", x, y+30); }
    }
    
    // Floor
    ctx.fillStyle = "#111";
    ctx.fillRect(0, SCREEN_H - TILE_SIZE, editorData.length * TILE_SIZE, TILE_SIZE);
    
    ctx.restore();
}

// Editor Interaction
canvas.addEventListener('mousedown', (e) => {
    if(gameState !== "EDITOR") return;
    let rect = canvas.getBoundingClientRect();
    let mx = e.clientX - rect.left + cameraX;
    let my = e.clientY - rect.top;
    
    let idx = Math.floor(mx / TILE_SIZE);
    if(idx >= 0 && idx < editorData.length && my < SCREEN_H - TILE_SIZE && my > SCREEN_H - (TILE_SIZE*3)) {
        // Map tool to char
        const chars = ['.', '1', '2', '3', '4'];
        editorData[idx] = chars[editTool];
    }
});

// Editor Scrolling
window.addEventListener('keydown', e => {
    if(gameState === "EDITOR") {
        if(e.code === "ArrowRight") cameraX += 20;
        if(e.code === "ArrowLeft") cameraX -= 20;
    }
});

function saveCustomLevel() {
    let name = prompt("Name your level:", "My Level");
    if(!name) return;
    
    let str = editorData.join('');
    let saved = JSON.parse(localStorage.getItem('geoDashLevels') || "[]");
    saved.push({name: name, data: str});
    localStorage.setItem('geoDashLevels', JSON.stringify(saved));
    alert("Saved to 'Your Games'!");
    showMenu();
}

// --- CONTROLS ---
let mouseDown = false;
window.addEventListener('mousedown', () => { mouseDown = true; jump(); });
window.addEventListener('mouseup', () => { mouseDown = false; });
window.addEventListener('keydown', e => { if(e.code==='Space') { mouseDown = true; jump(); } });
window.addEventListener('keyup', e => { if(e.code==='Space') mouseDown = false; });

function loop() {
    if(gameState === "MENU" || gameState === "DEAD") return;
    requestAnimationFrame(loop);
    
    if(gameState === "PLAYING") {
        update();
        draw();
    } else if (gameState === "EDITOR") {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        draw(); // Draw calls drawEditor
    }
    frame++;
}

// --- HELPER UI ---
function restartLevel() {
    document.getElementById('game-over').classList.add('hidden');
    startSession(currentLevelData);
}

function showMenu() {
    gameState = "MENU";
    document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden')); // Hide all overlays
    document.getElementById('editor-ui').classList.add('hidden');
    document.getElementById('main-menu').classList.remove('hidden');
    document.getElementById('ui-layer').style.pointerEvents = "none";
    renderMenu();
    ctx.clearRect(0,0,canvas.width,canvas.height);
}

function deleteCustom(i) {
    let saved = JSON.parse(localStorage.getItem('geoDashLevels'));
    saved.splice(i, 1);
    localStorage.setItem('geoDashLevels', JSON.stringify(saved));
    renderMenu();
}

// Start
renderMenu();

</script>
</body>
</html>
